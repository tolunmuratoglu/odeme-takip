<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeme Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK v10 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .grid-card { break-inside: avoid; page-break-inside: avoid; }
        @media (max-width: 768px) {
            .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
            .content-wrapper { padding-bottom: 80px; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    
    <!-- GİRİŞ/KAYIT EKRANI -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="wallet" class="text-white" style="width:40px; height:40px"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Ödeme Takip</h1>
                <p class="text-gray-600">Ödemelerinizi kolayca yönetin</p>
            </div>
            
            <div class="flex gap-2 mb-6">
                <button onclick="authApp.showLogin()" id="loginTab" class="flex-1 py-3 rounded-lg font-semibold bg-indigo-600 text-white">Giriş Yap</button>
                <button onclick="authApp.showRegister()" id="registerTab" class="flex-1 py-3 rounded-lg font-semibold bg-gray-200 text-gray-700">Kayıt Ol</button>
            </div>
            
            <div id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Email</label>
                        <input type="email" id="loginEmail" placeholder="ornek@email.com" class="w-full border-2 rounded-lg px-4 py-3">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Şifre</label>
                        <input type="password" id="loginPassword" placeholder="••••••••" class="w-full border-2 rounded-lg px-4 py-3">
                    </div>
                    <button onclick="authApp.login()" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition">
                        Giriş Yap
                    </button>
                    
                    <div class="relative my-6">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white text-gray-500">veya</span>
                        </div>
                    </div>
                    
                    <button onclick="authApp.googleLogin()" class="w-full bg-white border-2 border-gray-300 text-gray-700 font-semibold py-3 rounded-lg hover:bg-gray-50 transition flex items-center justify-center gap-3">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19.8055 10.2292C19.8055 9.55156 19.7501 8.86719 19.6316 8.19531H10.2002V12.0492H15.6014C15.3734 13.2911 14.6576 14.3898 13.6174 15.0875V17.5866H16.8295C18.7165 15.8449 19.8055 13.2728 19.8055 10.2292Z" fill="#4285F4"/>
                            <path d="M10.2002 20C12.9507 20 15.2559 19.1044 16.8328 17.5866L13.6207 15.0875C12.7384 15.6972 11.6028 16.0428 10.2035 16.0428C7.54343 16.0428 5.30085 14.2828 4.52184 11.9169H1.2168V14.4922C2.82679 17.6922 6.36168 20 10.2002 20Z" fill="#34A853"/>
                            <path d="M4.51852 11.9169C4.0772 10.6753 4.0772 9.32813 4.51852 8.08646V5.51116H1.21681C-0.175606 8.28021 -0.175606 11.7232 1.21681 14.4922L4.51852 11.9169Z" fill="#FBBC04"/>
                            <path d="M10.2002 3.95719C11.6795 3.93553 13.1041 4.47553 14.186 5.46803L17.0269 2.62719C15.1688 0.889693 12.7249 -0.0641574 10.2002 -0.0391574C6.36168 -0.0391574 2.82679 2.26719 1.2168 5.51115L4.51851 8.08645C5.29418 5.71719 7.5401 3.95719 10.2002 3.95719Z" fill="#EA4335"/>
                        </svg>
                        Google ile Giriş Yap
                    </button>
                </div>
            </div>
            
            <div id="registerForm" style="display: none;">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Email</label>
                        <input type="email" id="registerEmail" placeholder="ornek@email.com" class="w-full border-2 rounded-lg px-4 py-3">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Şifre (min. 6 karakter)</label>
                        <input type="password" id="registerPassword" placeholder="••••••••" class="w-full border-2 rounded-lg px-4 py-3">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-700">Şifre Tekrar</label>
                        <input type="password" id="registerPasswordConfirm" placeholder="••••••••" class="w-full border-2 rounded-lg px-4 py-3">
                    </div>
                    <button onclick="authApp.register()" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition">
                        Kayıt Ol
                    </button>
                    
                    <div class="relative my-6">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white text-gray-500">veya</span>
                        </div>
                    </div>
                    
                    <button onclick="authApp.googleLogin()" class="w-full bg-white border-2 border-gray-300 text-gray-700 font-semibold py-3 rounded-lg hover:bg-gray-50 transition flex items-center justify-center gap-3">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19.8055 10.2292C19.8055 9.55156 19.7501 8.86719 19.6316 8.19531H10.2002V12.0492H15.6014C15.3734 13.2911 14.6576 14.3898 13.6174 15.0875V17.5866H16.8295C18.7165 15.8449 19.8055 13.2728 19.8055 10.2292Z" fill="#4285F4"/>
                            <path d="M10.2002 20C12.9507 20 15.2559 19.1044 16.8328 17.5866L13.6207 15.0875C12.7384 15.6972 11.6028 16.0428 10.2035 16.0428C7.54343 16.0428 5.30085 14.2828 4.52184 11.9169H1.2168V14.4922C2.82679 17.6922 6.36168 20 10.2002 20Z" fill="#34A853"/>
                            <path d="M4.51852 11.9169C4.0772 10.6753 4.0772 9.32813 4.51852 8.08646V5.51116H1.21681C-0.175606 8.28021 -0.175606 11.7232 1.21681 14.4922L4.51852 11.9169Z" fill="#FBBC04"/>
                            <path d="M10.2002 3.95719C11.6795 3.93553 13.1041 4.47553 14.186 5.46803L17.0269 2.62719C15.1688 0.889693 12.7249 -0.0641574 10.2002 -0.0391574C6.36168 -0.0391574 2.82679 2.26719 1.2168 5.51115L4.51851 8.08645C5.29418 5.71719 7.5401 3.95719 10.2002 3.95719Z" fill="#EA4335"/>
                        </svg>
                        Google ile Kayıt Ol
                    </button>
                </div>
            </div>
            
            <div id="authError" class="hidden mt-4 p-3 bg-red-50 border-2 border-red-300 rounded-lg">
                <p class="text-red-700 text-sm font-medium"></p>
            </div>
            <div id="authSuccess" class="hidden mt-4 p-3 bg-green-50 border-2 border-green-300 rounded-lg">
                <p class="text-green-700 text-sm font-medium"></p>
            </div>
        </div>
    </div>
    
    <!-- ANA UYGULAMA -->
    <div id="mainApp" style="display: none;" class="p-4">
        <div id="app" class="max-w-6xl mx-auto content-wrapper"></div>
        
        <div id="yeniOdemeModal" class="modal">
            <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4"><i data-lucide="plus-circle"></i> Yeni Ödeme Ekle</h2>
                <div class="space-y-4">
                    <input type="text" id="modalAciklama" placeholder="Açıklama" class="w-full border-2 rounded-lg px-4 py-2">
                    <input type="number" id="modalTutar" placeholder="Tutar" class="w-full border-2 rounded-lg px-4 py-2">
                    <input type="date" id="modalVadeTarihi" class="w-full border-2 rounded-lg px-4 py-2">
                    <select id="modalKategori" class="w-full border-2 rounded-lg px-4 py-2"></select>
                    <div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="modalTekrarlar" class="w-5 h-5">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="refresh-cw" style="width:18px"></i>
                                    <span class="font-semibold">Tekrarlayan</span>
                                </div>
                                <p class="text-sm mt-1 text-gray-600">Tamamlandığında sonraki aya devret</p>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="app.odemeEkleModal()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-semibold">Ekle</button>
                    <button onclick="app.closeYeniOdemeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold">İptal</button>
                </div>
            </div>
        </div>
        
        <div id="editModal" class="modal">
            <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4"><i data-lucide="edit"></i> Ödeme Düzenle</h2>
                <div class="space-y-4">
                    <input type="text" id="editAciklama" placeholder="Açıklama" class="w-full border-2 rounded-lg px-4 py-2">
                    <input type="number" id="editTutar" placeholder="Tutar" class="w-full border-2 rounded-lg px-4 py-2">
                    <input type="date" id="editVadeTarihi" class="w-full border-2 rounded-lg px-4 py-2">
                    <select id="editKategori" class="w-full border-2 rounded-lg px-4 py-2"></select>
                    <label class="flex items-center gap-2"><input type="checkbox" id="editTekrarlar" class="w-5 h-5"> Tekrarlayan</label>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="app.saveEdit()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">Kaydet</button>
                    <button onclick="app.closeEditModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg">İptal</button>
                </div>
            </div>
        </div>
        
        <div class="mobile-nav md:hidden">
            <div class="grid grid-cols-4 gap-1 p-2">
                <button onclick="app.setSekme('odemeler')" id="mobNav1" class="flex flex-col items-center gap-1 p-2 rounded-lg"><i data-lucide="calendar" style="width:24px"></i><span class="text-xs">Ödemeler</span></button>
                <button onclick="app.setSekme('bakiye')" id="mobNav2" class="flex flex-col items-center gap-1 p-2 rounded-lg"><i data-lucide="wallet" style="width:24px"></i><span class="text-xs">Bakiye</span></button>
                <button onclick="app.setSekme('kategoriler')" id="mobNav3" class="flex flex-col items-center gap-1 p-2 rounded-lg"><i data-lucide="tag" style="width:24px"></i><span class="text-xs">Kategori</span></button>
                <button onclick="app.setSekme('gecmis')" id="mobNav4" class="flex flex-col items-center gap-1 p-2 rounded-lg"><i data-lucide="filter" style="width:24px"></i><span class="text-xs">Geçmiş</span></button>
            </div>
        </div>
    </div>
    
    <script>
        // ==========================================
        // FİREBASE YAPILANDIRMASI
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCYqy0PZPUV23XIwcsS0sSRheIZpgqwn1s",
            authDomain: "odeme-takip-b34e1.firebaseapp.com",
            projectId: "odeme-takip-b34e1",
            storageBucket: "odeme-takip-b34e1.firebasestorage.app",
            messagingSenderId: "985345280614",
            appId: "1:985345280614:web:b27ab143ac17d987863ba7",
            measurementId: "G-DBR8GPCQJ1"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // KATEGORİLER
        const KATS = [
            { id: 'kira', isim: 'Kira', renk: 'bg-orange-500', icon: 'home' },
            { id: 'faturalar', isim: 'Faturalar', renk: 'bg-red-500', icon: 'zap' },
            { id: 'krediler', isim: 'Krediler', renk: 'bg-purple-500', icon: 'trending-down' },
            { id: 'kredikarti', isim: 'Kredi Kartı', renk: 'bg-pink-500', icon: 'credit-card' },
            { id: 'okul', isim: 'Okul', renk: 'bg-blue-500', icon: 'book' },
            { id: 'birikim', isim: 'Birikim', renk: 'bg-green-500', icon: 'piggy-bank' },
            { id: 'diger', isim: 'Diğer', renk: 'bg-gray-500', icon: 'more-horizontal' }
        ];
        
        // GİRİŞ/KAYIT UYGULAMASI
        const authApp = {
            showLogin() {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('loginTab').classList.add('bg-indigo-600', 'text-white');
                document.getElementById('loginTab').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('registerTab').classList.remove('bg-indigo-600', 'text-white');
                document.getElementById('registerTab').classList.add('bg-gray-200', 'text-gray-700');
                this.hideMessages();
            },
            showRegister() {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
                document.getElementById('registerTab').classList.add('bg-indigo-600', 'text-white');
                document.getElementById('registerTab').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('loginTab').classList.remove('bg-indigo-600', 'text-white');
                document.getElementById('loginTab').classList.add('bg-gray-200', 'text-gray-700');
                this.hideMessages();
            },
            showError(msg) {
                const errorDiv = document.getElementById('authError');
                errorDiv.querySelector('p').textContent = msg;
                errorDiv.classList.remove('hidden');
                document.getElementById('authSuccess').classList.add('hidden');
            },
            showSuccess(msg) {
                const successDiv = document.getElementById('authSuccess');
                successDiv.querySelector('p').textContent = msg;
                successDiv.classList.remove('hidden');
                document.getElementById('authError').classList.add('hidden');
            },
            hideMessages() {
                document.getElementById('authError').classList.add('hidden');
                document.getElementById('authSuccess').classList.add('hidden');
            },
            async login() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                if (!email || !password) { this.showError('Lütfen tüm alanları doldurun!'); return; }
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    this.showSuccess('Giriş başarılı!');
                } catch (error) {
                    if (error.code === 'auth/user-not-found') this.showError('Bu email ile kayıtlı kullanıcı bulunamadı!');
                    else if (error.code === 'auth/wrong-password') this.showError('Hatalı şifre!');
                    else if (error.code === 'auth/invalid-email') this.showError('Geçersiz email!');
                    else this.showError('Giriş yapılamadı!');
                }
            },
            async register() {
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
                if (!email || !password || !passwordConfirm) { this.showError('Lütfen tüm alanları doldurun!'); return; }
                if (password !== passwordConfirm) { this.showError('Şifreler eşleşmiyor!'); return; }
                if (password.length < 6) { this.showError('Şifre en az 6 karakter olmalı!'); return; }
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                    this.showSuccess('Kayıt başarılı!');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') this.showError('Bu email zaten kullanımda!');
                    else if (error.code === 'auth/invalid-email') this.showError('Geçersiz email!');
                    else this.showError('Kayıt olunamadı!');
                }
            },
            async googleLogin() {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.setCustomParameters({
                        prompt: 'select_account'
                    });
                    await auth.signInWithPopup(provider);
                    this.showSuccess('Google ile giriş başarılı!');
                } catch (error) {
                    console.error('Google login error:', error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        this.showError('Giriş penceresi kapatıldı!');
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        // Kullanıcı iptal etti, sessizce geç
                    } else {
                        this.showError('Google ile giriş yapılamadı!');
                    }
                }
            }
        };
        
        // AUTH STATE DEĞİŞİKLİĞİ
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                app.currentUser = user;
                app.init();
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });
        
        // ANA UYGULAMA
        const app = {
            currentUser: null,
            odemeler: [],
            gelirler: {},
            butce: {},
            filtre: 'hepsi',
            katFiltre: 'hepsi',
            arama: '',
            sekme: 'odemeler',
            secilenAy: null,
            editingId: null,
            secili: new Set(),
            gecmisSekme: 'aylik',
            secilenYil: null,
            
            async init() {
                this.secilenAy = this.getAyKey(new Date());
                this.secilenYil = new Date().getFullYear();
                await this.loadData();
                this.render();
                lucide.createIcons();
            },
            
            async loadData() {
                if (!this.currentUser) return;
                try {
                    const odemelerSnap = await db.collection('users').doc(this.currentUser.uid).collection('odemeler').get();
                    this.odemeler = odemelerSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    
                    const gelirlerSnap = await db.collection('users').doc(this.currentUser.uid).collection('gelirler').get();
                    this.gelirler = {};
                    gelirlerSnap.docs.forEach(doc => { this.gelirler[doc.id] = doc.data().tutar; });
                    
                    const butceSnap = await db.collection('users').doc(this.currentUser.uid).collection('butce').get();
                    this.butce = {};
                    butceSnap.docs.forEach(doc => { this.butce[doc.id] = doc.data().limit; });
                } catch (error) {
                    console.error('Veri yükleme hatası:', error);
                    this.showMsg('Veriler yüklenemedi!', 'error');
                }
            },
            
            async saveOdeme(odeme) {
                if (!this.currentUser) return;
                try {
                    await db.collection('users').doc(this.currentUser.uid).collection('odemeler').doc(odeme.id).set(odeme);
                } catch (error) {
                    console.error('Ödeme kaydetme hatası:', error);
                    this.showMsg('Ödeme kaydedilemedi!', 'error');
                }
            },
            
            async deleteOdeme(id) {
                if (!this.currentUser) return;
                try {
                    await db.collection('users').doc(this.currentUser.uid).collection('odemeler').doc(id).delete();
                } catch (error) {
                    console.error('Ödeme silme hatası:', error);
                }
            },
            
            async saveGelir(ay, tutar) {
                if (!this.currentUser) return;
                try {
                    await db.collection('users').doc(this.currentUser.uid).collection('gelirler').doc(ay).set({ tutar });
                } catch (error) {
                    console.error('Gelir kaydetme hatası:', error);
                }
            },
            
            async saveButce(kategori, limit) {
                if (!this.currentUser) return;
                try {
                    await db.collection('users').doc(this.currentUser.uid).collection('butce').doc(kategori).set({ limit });
                } catch (error) {
                    console.error('Bütçe kaydetme hatası:', error);
                }
            },
            
            async logout() {
                if (confirm('Çıkış yapmak istediğinize emin misiniz?')) {
                    await auth.signOut();
                }
            },
            
            showMsg(msg, type = 'info') {
                const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
                const div = document.createElement('div');
                div.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-in`;
                div.textContent = msg;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            },
            
            getAyKey(tarih) { return tarih.getFullYear() + '-' + String(tarih.getMonth() + 1).padStart(2, '0'); },
            getAyIsim(key) { const [y, m] = key.split('-'); return new Date(y, m - 1, 1).toLocaleDateString('tr-TR', { year: 'numeric', month: 'long' }); },
            getBuAy() { return this.getAyKey(new Date()); },
            getGelir(ay) { return this.gelirler[ay] || 0; },
            async setGelir(ay, g) { this.gelirler[ay] = parseFloat(g) || 0; await this.saveGelir(ay, this.gelirler[ay]); this.render(); lucide.createIcons(); },
            getKatButce(kat) { return this.butce[kat] || 0; },
            async setKatButce(kat, lim) { this.butce[kat] = parseFloat(lim) || 0; await this.saveButce(kat, this.butce[kat]); this.render(); lucide.createIcons(); },
            
            getAyGider(ay) {
                return this.odemeler.filter(o => {
                    if (!o.tamamlandi) return false;
                    const tarih = o.odemeTarihi ? new Date(o.odemeTarihi) : new Date(o.vadeTarihi);
                    return this.getAyKey(tarih) === ay;
                });
            },
            
            getKatHarca(kat, ay = null) {
                const a = ay || this.getBuAy();
                return this.getAyGider(a).filter(o => o.kategori === kat).reduce((t, o) => t + o.tutar, 0);
            },
            
            getBakiye(ay) {
                const gelir = this.getGelir(ay);
                const gider = this.getAyGider(ay).reduce((t, o) => t + o.tutar, 0);
                return gelir - gider;
            },
            
            getTumAylar() {
                const aylar = new Set([this.getBuAy()]);
                this.odemeler.forEach(o => {
                    if (o.tamamlandi) {
                        const t = o.odemeTarihi ? new Date(o.odemeTarihi) : new Date(o.vadeTarihi);
                        aylar.add(this.getAyKey(t));
                    }
                });
                Object.keys(this.gelirler).forEach(a => aylar.add(a));
                return Array.from(aylar).sort((a, b) => b.localeCompare(a));
            },
            
            openYeniOdemeModal() {
                document.getElementById('yeniOdemeModal').classList.add('active');
                lucide.createIcons();
            },
            
            closeYeniOdemeModal() {
                document.getElementById('yeniOdemeModal').classList.remove('active');
                document.getElementById('modalAciklama').value = '';
                document.getElementById('modalTutar').value = '';
                document.getElementById('modalVadeTarihi').value = '';
                document.getElementById('modalKategori').value = 'kira';
                document.getElementById('modalTekrarlar').checked = false;
            },
            
            async odemeEkleModal() {
                const acik = document.getElementById('modalAciklama').value;
                const tut = document.getElementById('modalTutar').value;
                const vade = document.getElementById('modalVadeTarihi').value;
                const kat = document.getElementById('modalKategori').value;
                const tekr = document.getElementById('modalTekrarlar').checked;
                
                if (!acik || !tut || !vade) { this.showMsg('Lütfen tüm alanları doldurun!', 'error'); return; }
                
                const o = {
                    id: Date.now().toString(),
                    aciklama: acik,
                    tutar: parseFloat(tut),
                    vadeTarihi: vade,
                    tamamlandi: false,
                    odemeTarihi: null,
                    tekrarlar: tekr,
                    kategori: kat
                };
                
                this.odemeler.push(o);
                await this.saveOdeme(o);
                this.showMsg('Ödeme eklendi!', 'success');
                this.closeYeniOdemeModal();
                this.render();
                lucide.createIcons();
            },
            
            openEditModal(id) {
                const o = this.odemeler.find(x => x.id === id);
                if (!o) return;
                this.editingId = id;
                document.getElementById('editAciklama').value = o.aciklama;
                document.getElementById('editTutar').value = o.tutar;
                document.getElementById('editVadeTarihi').value = o.vadeTarihi;
                document.getElementById('editKategori').value = o.kategori || 'kira';
                document.getElementById('editTekrarlar').checked = o.tekrarlar;
                document.getElementById('editModal').classList.add('active');
                lucide.createIcons();
            },
            
            closeEditModal() {
                this.editingId = null;
                document.getElementById('editModal').classList.remove('active');
            },
            
            async saveEdit() {
                if (!this.editingId) return;
                const acik = document.getElementById('editAciklama').value;
                const tut = document.getElementById('editTutar').value;
                const vade = document.getElementById('editVadeTarihi').value;
                const kat = document.getElementById('editKategori').value;
                const tekr = document.getElementById('editTekrarlar').checked;
                if (!acik || !tut || !vade) { this.showMsg('Lütfen tüm alanları doldurun!', 'error'); return; }
                
                this.odemeler = this.odemeler.map(o => {
                    if (o.id === this.editingId) {
                        return { ...o, aciklama: acik, tutar: parseFloat(tut), vadeTarihi: vade, kategori: kat, tekrarlar: tekr };
                    }
                    return o;
                });
                
                const updatedOdeme = this.odemeler.find(o => o.id === this.editingId);
                await this.saveOdeme(updatedOdeme);
                this.closeEditModal();
                this.showMsg('Güncellendi!', 'success');
                this.render();
                lucide.createIcons();
            },
            
            async odemeSil(id) {
                if (confirm('Silmek istediğinize emin misiniz?')) {
                    this.odemeler = this.odemeler.filter(o => o.id !== id);
                    await this.deleteOdeme(id);
                    this.showMsg('Silindi!', 'success');
                    this.render();
                    lucide.createIcons();
                }
            },
            
            async topluSil() {
                if (this.secili.size === 0) { this.showMsg('Lütfen seçim yapın!', 'error'); return; }
                if (confirm(`${this.secili.size} ödeme silinecek. Emin misiniz?`)) {
                    for (const id of this.secili) {
                        await this.deleteOdeme(id);
                    }
                    this.odemeler = this.odemeler.filter(o => !this.secili.has(o.id));
                    this.secili.clear();
                    this.showMsg('Silindi!', 'success');
                    this.render();
                    lucide.createIcons();
                }
            },
            
            async topluTamamla() {
                if (this.secili.size === 0) { this.showMsg('Lütfen seçim yapın!', 'error'); return; }
                for (const id of this.secili) {
                    await this.odemeTamamla(id, true);
                }
                this.secili.clear();
                this.showMsg('Tamamlandı!', 'success');
                this.render();
                lucide.createIcons();
            },
            
            toggleSecim(id) {
                if (this.secili.has(id)) this.secili.delete(id);
                else this.secili.add(id);
                this.render();
                lucide.createIcons();
            },
            
            tumunuSec() {
                const fil = this.getFiltreli();
                if (this.secili.size === fil.length) this.secili.clear();
                else fil.forEach(o => this.secili.add(o.id));
                this.render();
                lucide.createIcons();
            },
            
            async tekrarDurdur(id) {
                this.odemeler = this.odemeler.map(o => o.id === id ? { ...o, tekrarlar: false } : o);
                const updatedOdeme = this.odemeler.find(o => o.id === id);
                await this.saveOdeme(updatedOdeme);
                this.render();
                lucide.createIcons();
            },
            
            sonrakiAy(o) {
                const eski = new Date(o.vadeTarihi);
                const yeni = new Date(eski);
                yeni.setMonth(yeni.getMonth() + 1);
                if (yeni.getDate() !== eski.getDate()) yeni.setDate(0);
                return {
                    id: Date.now().toString() + Math.random(),
                    aciklama: o.aciklama,
                    tutar: o.tutar,
                    vadeTarihi: yeni.toISOString().split('T')[0],
                    tamamlandi: false,
                    odemeTarihi: null,
                    tekrarlar: true,
                    kategori: o.kategori
                };
            },
            
            async odemeTamamla(id, silent = false) {
                const o = this.odemeler.find(x => x.id === id);
                if (!o) return;
                
                if (!o.tamamlandi && o.tekrarlar) {
                    const tam = { ...o, tamamlandi: true, odemeTarihi: new Date().toISOString() };
                    const yeni = this.sonrakiAy(o);
                    this.odemeler = this.odemeler.map(x => x.id === id ? tam : x).concat(yeni);
                    await this.saveOdeme(tam);
                    await this.saveOdeme(yeni);
                } else {
                    this.odemeler = this.odemeler.map(x => {
                        if (x.id === id) {
                            return { ...x, tamamlandi: !x.tamamlandi, odemeTarihi: !x.tamamlandi ? new Date().toISOString() : null };
                        }
                        return x;
                    });
                    const updatedOdeme = this.odemeler.find(x => x.id === id);
                    await this.saveOdeme(updatedOdeme);
                }
                
                if (!silent) {
                    this.render();
                    lucide.createIcons();
                }
            },
            
            gunFark(vade) {
                const bugun = new Date();
                bugun.setHours(0,0,0,0);
                const v = new Date(vade);
                v.setHours(0,0,0,0);
                return Math.ceil((v - bugun) / 86400000);
            },
            
            durum(vade, tam) {
                if (tam) return 'tamamlandi';
                const f = this.gunFark(vade);
                if (f < 0) return 'gecmis';
                if (f <= 3) return 'acil';
                if (f <= 7) return 'yakin';
                return 'normal';
            },
            
            durumRenk(d) {
                const renkler = {
                    gecmis: 'bg-red-50 border-red-300',
                    acil: 'bg-orange-50 border-orange-300',
                    yakin: 'bg-yellow-50 border-yellow-300',
                    tamamlandi: 'bg-green-50 border-green-300'
                };
                return renkler[d] || 'bg-white border-gray-200';
            },
            
            durumText(vade, tam) {
                if (tam) return 'Ödendi ✓';
                const f = this.gunFark(vade);
                if (f < 0) return Math.abs(f) + ' gün gecikmiş!';
                if (f === 0) return 'BUGÜN!';
                if (f === 1) return 'Yarın';
                return f + ' gün kaldı';
            },
            
            buAyMi(o) {
                const b = new Date();
                const v = new Date(o.vadeTarihi);
                return v.getMonth() === b.getMonth() && v.getFullYear() === b.getFullYear();
            },
            
            getFiltreli() {
                return this.odemeler.filter(o => {
                    if (this.katFiltre !== 'hepsi' && o.kategori !== this.katFiltre) return false;
                    if (this.arama && !o.aciklama.toLowerCase().includes(this.arama.toLowerCase())) return false;
                    if (this.filtre === 'bekleyen') return !o.tamamlandi;
                    if (this.filtre === 'tamamlanan') return o.tamamlandi;
                    if (this.filtre === 'tekrarli') return o.tekrarlar && !o.tamamlandi;
                    if (this.filtre === 'buay') return this.buAyMi(o) && !o.tamamlandi;
                    return true;
                }).sort((a, b) => new Date(a.vadeTarihi) - new Date(b.vadeTarihi));
            },
            
            getBuAyOdemeler() {
                return this.odemeler.filter(o => this.buAyMi(o) && !o.tamamlandi);
            },
            
            getStats() {
                const bek = this.odemeler.filter(o => !o.tamamlandi);
                const tekr = bek.filter(o => o.tekrarlar);
                const buAy = this.getBuAyOdemeler();
                return {
                    buAyAdet: buAy.length,
                    buAyToplam: buAy.reduce((t, o) => t + o.tutar, 0),
                    toplamBekleyen: bek.reduce((t, o) => t + o.tutar, 0),
                    tekrarliAdet: tekr.length,
                    tekrarliToplam: tekr.reduce((t, o) => t + o.tutar, 0)
                };
            },
            
            getAylikGec() {
                const aylar = {};
                this.odemeler.forEach(o => {
                    if (!o.tamamlandi) return;
                    const t = o.odemeTarihi ? new Date(o.odemeTarihi) : new Date(o.vadeTarihi);
                    const key = this.getAyKey(t);
                    if (!aylar[key]) {
                        aylar[key] = { ay: t.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long' }), toplam: 0, adet: 0, odemeler: [] };
                    }
                    aylar[key].toplam += o.tutar;
                    aylar[key].adet += 1;
                    aylar[key].odemeler.push(o);
                });
                return Object.entries(aylar).sort((a, b) => b[0].localeCompare(a[0])).map(i => i[1]);
            },
            
            getYillikGec() {
                const yillar = {};
                this.odemeler.forEach(o => {
                    if (!o.tamamlandi) return;
                    const t = o.odemeTarihi ? new Date(o.odemeTarihi) : new Date(o.vadeTarihi);
                    const yil = t.getFullYear();
                    const ayKey = this.getAyKey(t);
                    
                    if (!yillar[yil]) yillar[yil] = { yil, aylar: {}, toplamGelir: 0, toplamGider: 0, toplamBakiye: 0 };
                    if (!yillar[yil].aylar[ayKey]) {
                        yillar[yil].aylar[ayKey] = { 
                            ay: t.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long' }),
                            gelir: this.getGelir(ayKey), gider: 0, bakiye: 0, adet: 0
                        };
                    }
                    yillar[yil].aylar[ayKey].gider += o.tutar;
                    yillar[yil].aylar[ayKey].adet += 1;
                });
                
                Object.keys(this.gelirler).forEach(ayKey => {
                    const [yilStr] = ayKey.split('-');
                    const yil = parseInt(yilStr);
                    if (!yillar[yil]) yillar[yil] = { yil, aylar: {}, toplamGelir: 0, toplamGider: 0, toplamBakiye: 0 };
                    if (!yillar[yil].aylar[ayKey]) {
                        const [y, m] = ayKey.split('-');
                        yillar[yil].aylar[ayKey] = {
                            ay: new Date(y, m - 1, 1).toLocaleDateString('tr-TR', { year: 'numeric', month: 'long' }),
                            gelir: this.getGelir(ayKey), gider: 0, bakiye: 0, adet: 0
                        };
                    } else {
                        yillar[yil].aylar[ayKey].gelir = this.getGelir(ayKey);
                    }
                });
                
                Object.keys(yillar).forEach(yil => {
                    const aylarArr = Object.keys(yillar[yil].aylar).sort((a, b) => a.localeCompare(b));
                    aylarArr.forEach(ayKey => {
                        const ay = yillar[yil].aylar[ayKey];
                        ay.bakiye = ay.gelir - ay.gider;
                        yillar[yil].toplamGelir += ay.gelir;
                        yillar[yil].toplamGider += ay.gider;
                    });
                    yillar[yil].toplamBakiye = yillar[yil].toplamGelir - yillar[yil].toplamGider;
                    yillar[yil].aylarArr = aylarArr.map(k => yillar[yil].aylar[k]);
                });
                
                return Object.values(yillar).sort((a, b) => b.yil - a.yil);
            },
            
            setSekme(s) {
                this.sekme = s;
                if (s === 'bakiye') this.secilenAy = this.getBuAy();
                ['mobNav1', 'mobNav2', 'mobNav3', 'mobNav4'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.classList.remove('bg-indigo-600', 'text-white');
                });
                const map = { odemeler: 'mobNav1', bakiye: 'mobNav2', kategoriler: 'mobNav3', gecmis: 'mobNav4' };
                const btn = document.getElementById(map[s]);
                if (btn) btn.classList.add('bg-indigo-600', 'text-white');
                this.render();
                lucide.createIcons();
            },
            
            setFiltre(f) { this.filtre = f; this.render(); lucide.createIcons(); },
            setKatFiltre(k) { this.katFiltre = k; this.render(); lucide.createIcons(); },
            setArama(t) { this.arama = t; this.render(); lucide.createIcons(); },
            secAy(a) { this.secilenAy = a; this.render(); lucide.createIcons(); },
            
            oncekiAy() {
                const [y, m] = this.secilenAy.split('-');
                const t = new Date(y, m - 1, 1);
                t.setMonth(t.getMonth() - 1);
                this.secilenAy = this.getAyKey(t);
                this.render();
                lucide.createIcons();
            },
            
            sonrakiAyNav() {
                const [y, m] = this.secilenAy.split('-');
                const t = new Date(y, m - 1, 1);
                t.setMonth(t.getMonth() + 1);
                const buAy = this.getBuAy();
                if (this.getAyKey(t) <= buAy) {
                    this.secilenAy = this.getAyKey(t);
                    this.render();
                    lucide.createIcons();
                }
            },
            
            setGecmisSekme(s) { this.gecmisSekme = s; this.render(); lucide.createIcons(); },
            setYil(y) { this.secilenYil = y; this.render(); lucide.createIcons(); },
            
            renderKategoriler() {
                const buAy = this.getBuAy();
                let h = '<div class="bg-white rounded-2xl shadow-lg p-6 mb-6">';
                h += '<h2 class="text-2xl font-bold text-gray-800 mb-4"><i data-lucide="tag"></i> Kategori Yönetimi</h2>';
                h += '<p class="text-gray-600 mb-6">Her kategori için aylık bütçe limiti belirleyin</p>';
                h += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                KATS.forEach(k => {
                    const harc = this.getKatHarca(k.id, buAy);
                    const lim = this.getKatButce(k.id);
                    const yuz = lim > 0 ? (harc / lim) * 100 : 0;
                    const asim = harc > lim && lim > 0;
                    h += `<div class="bg-gray-50 rounded-xl p-4 border-2 ${asim ? 'border-red-400' : 'border-gray-200'}">`;
                    h += `<div class="flex items-center justify-between mb-3">`;
                    h += `<div class="flex items-center gap-2"><div class="w-10 h-10 ${k.renk} rounded-lg flex items-center justify-center">`;
                    h += `<i data-lucide="${k.icon}" class="text-white" style="width:20px"></i></div>`;
                    h += `<div><h3 class="font-bold text-gray-800">${k.isim}</h3>`;
                    h += `<p class="text-xs text-gray-600">${this.odemeler.filter(o => o.kategori === k.id && !o.tamamlandi).length} bekleyen</p></div></div>`;
                    if (asim) h += '<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full font-semibold">Aşıldı!</span>';
                    h += '</div><div class="mb-3">';
                    h += `<div class="flex justify-between text-sm mb-1"><span class="text-gray-600">Harcanan</span>`;
                    h += `<span class="font-bold ${asim ? 'text-red-600' : 'text-gray-800'}">${harc.toLocaleString('tr-TR')} ₺</span></div>`;
                    if (lim > 0) {
                        h += `<div class="w-full bg-gray-200 rounded-full h-3">`;
                        h += `<div class="${asim ? 'bg-red-500' : 'bg-green-500'} h-3 rounded-full transition-all" style="width: ${Math.min(yuz, 100)}%"></div></div>`;
                        h += `<div class="flex justify-between text-xs mt-1"><span class="text-gray-500">Limit: ${lim.toLocaleString('tr-TR')} ₺</span>`;
                        h += `<span class="${asim ? 'text-red-600' : 'text-gray-600'}">${(lim - harc).toLocaleString('tr-TR')} ₺ kaldı</span></div>`;
                    }
                    h += '</div><div class="flex gap-2">';
                    h += `<input type="number" id="lim_${k.id}" placeholder="Limit" value="${lim || ''}" class="flex-1 text-sm border-2 rounded-lg px-3 py-2">`;
                    h += `<button onclick="app.setKatButce('${k.id}', document.getElementById('lim_${k.id}').value)" class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg">`;
                    h += `<i data-lucide="save" style="width:16px"></i></button></div></div>`;
                });
                h += '</div></div>';
                return h;
            },
            
            renderBakiye() {
                const aylar = this.getTumAylar();
                const buAy = this.getBuAy();
                const gelir = this.getGelir(buAy);
                const gider = this.getAyGider(buAy).reduce((t, o) => t + o.tutar, 0);
                const bakiye = gelir - gider;
                let h = '<div class="bg-white rounded-2xl shadow-lg p-6 mb-6">';
                h += '<div class="flex items-center justify-between mb-4">';
                h += '<h2 class="text-2xl font-bold text-gray-800"><i data-lucide="wallet"></i> Bu Ay Bakiye</h2>';
                h += `<span class="text-sm text-gray-600">${this.getAyIsim(buAy)}</span></div>`;
                if (gelir === 0) {
                    h += '<div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-4">';
                    h += '<p class="font-semibold text-yellow-800">Gelir girilmemiş</p></div>';
                }
                h += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">';
                h += `<div class="bg-green-50 rounded-xl p-4 border-2 border-green-200"><p class="text-sm text-green-700 mb-1">Gelir</p><p class="text-3xl font-bold text-green-700">${gelir.toLocaleString('tr-TR')} ₺</p></div>`;
                h += `<div class="bg-red-50 rounded-xl p-4 border-2 border-red-200"><p class="text-sm text-red-700 mb-1">Gider</p><p class="text-3xl font-bold text-red-700">${gider.toLocaleString('tr-TR')} ₺</p></div>`;
                h += `<div class="bg-indigo-50 rounded-xl p-4 border-2 ${bakiye < 0 ? 'border-red-400' : 'border-indigo-200'}"><p class="text-sm mb-1 ${bakiye < 0 ? 'text-red-700' : 'text-indigo-700'}">Bakiye</p><p class="text-3xl font-bold ${bakiye < 0 ? 'text-red-700' : 'text-indigo-700'}">${bakiye.toLocaleString('tr-TR')} ₺</p>`;
                if (bakiye < 0) h += '<p class="text-xs text-red-600 mt-1 font-medium">Aşım!</p>';
                h += '</div></div>';
                h += '<div class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200"><label class="block text-sm font-semibold mb-2">Gelir Girin</label><div class="flex gap-3">';
                h += `<input type="number" id="buAyGelir" placeholder="Gelir" value="${gelir || ''}" class="flex-1 border-2 rounded-lg px-4 py-3 text-lg">`;
                h += `<button onclick="app.setGelir('${buAy}', document.getElementById('buAyGelir').value)" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg"><i data-lucide="save" style="width:20px"></i> Kaydet</button></div></div></div>`;
                
                h += '<div class="bg-white rounded-2xl shadow-lg p-6 mb-6">';
                h += '<h2 class="text-2xl font-bold text-gray-800 mb-4"><i data-lucide="history"></i> Aylık Geçmiş</h2>';
                h += '<div class="flex items-center justify-between mb-6 p-4 bg-gray-50 rounded-xl">';
                h += '<button onclick="app.oncekiAy()" class="p-2 bg-white rounded-lg border-2"><i data-lucide="chevron-left" style="width:24px"></i></button>';
                h += `<span class="text-xl font-bold">${this.getAyIsim(this.secilenAy)}</span>`;
                h += `<button onclick="app.sonrakiAyNav()" class="p-2 bg-white rounded-lg border-2 ${this.secilenAy === buAy ? 'opacity-50' : ''}" ${this.secilenAy === buAy ? 'disabled' : ''}><i data-lucide="chevron-right" style="width:24px"></i></button></div>`;
                
                const secGelir = this.getGelir(this.secilenAy);
                const secGider = this.getAyGider(this.secilenAy);
                const secTopGider = secGider.reduce((t, o) => t + o.tutar, 0);
                const secBakiye = secGelir - secTopGider;
                h += '<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">';
                h += `<div class="bg-green-50 rounded-xl p-4 border-2"><p class="text-sm text-green-700">Gelir</p><p class="text-2xl font-bold text-green-700">${secGelir.toLocaleString('tr-TR')} ₺</p></div>`;
                h += `<div class="bg-red-50 rounded-xl p-4 border-2"><p class="text-sm text-red-700">Gider</p><p class="text-2xl font-bold text-red-700">${secTopGider.toLocaleString('tr-TR')} ₺</p></div>`;
                h += `<div class="bg-indigo-50 rounded-xl p-4 border-2 ${secBakiye < 0 ? 'border-red-400' : ''}"><p class="text-sm ${secBakiye < 0 ? 'text-red-700' : 'text-indigo-700'}">Bakiye</p><p class="text-2xl font-bold ${secBakiye < 0 ? 'text-red-700' : 'text-indigo-700'}">${secBakiye.toLocaleString('tr-TR')} ₺</p></div>`;
                h += `<div class="bg-gray-50 rounded-xl p-4 border-2"><p class="text-sm">Ödeme Sayısı</p><p class="text-2xl font-bold">${secGider.length}</p></div></div>`;
                
                if (this.secilenAy !== buAy || secGelir > 0) {
                    h += '<div class="bg-blue-50 rounded-xl p-4 border-2 mb-4"><label class="block text-sm font-semibold mb-2">' + this.getAyIsim(this.secilenAy) + ' Geliri</label><div class="flex gap-3">';
                    h += `<input type="number" id="secAyGelir" value="${secGelir || ''}" class="flex-1 border-2 rounded-lg px-4 py-2">`;
                    h += `<button onclick="app.setGelir('${this.secilenAy}', document.getElementById('secAyGelir').value)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg"><i data-lucide="save" style="width:18px"></i> Güncelle</button></div></div>`;
                }
                
                if (secGider.length > 0) {
                    h += '<div class="space-y-2"><h3 class="font-bold mb-3">Bu Aydaki Ödemeler</h3>';
                    secGider.forEach(o => {
                        const k = KATS.find(x => x.id === o.kategori);
                        h += '<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">';
                        h += `<div class="flex-1"><div class="flex items-center gap-2"><p class="font-medium text-gray-800">${o.aciklama}</p>`;
                        if (k) h += `<span class="text-xs ${k.renk} text-white px-2 py-1 rounded-full">${k.isim}</span>`;
                        if (o.tekrarlar) h += '<i data-lucide="refresh-cw" style="width:14px" class="text-purple-600"></i>';
                        h += `</div><p class="text-sm text-gray-600">Ödeme: ${o.odemeTarihi ? new Date(o.odemeTarihi).toLocaleDateString('tr-TR') : 'Bilinmiyor'}</p></div>`;
                        h += `<span class="font-bold text-lg">${o.tutar.toLocaleString('tr-TR')} ₺</span></div>`;
                    });
                    h += '</div>';
                } else {
                    h += '<div class="text-center py-8 text-gray-500"><i data-lucide="inbox" style="width:48px" class="mx-auto mb-2"></i><p>Bu ayda ödeme yok</p></div>';
                }
                h += '</div>';
                
                h += '<div class="bg-white rounded-2xl shadow-lg p-6">';
                h += '<h2 class="text-2xl font-bold text-gray-800 mb-4"><i data-lucide="bar-chart-2"></i> Tüm Aylar</h2><div class="space-y-3">';
                aylar.forEach(a => {
                    const g = this.getGelir(a);
                    const gid = this.getAyGider(a);
                    const topGid = gid.reduce((t, o) => t + o.tutar, 0);
                    const bak = g - topGid;
                    h += `<div class="p-4 rounded-xl border-2 ${bak < 0 ? 'bg-red-50 border-red-300' : 'bg-gray-50 border-gray-200'}">`;
                    h += `<div class="flex items-center justify-between mb-2"><span class="font-bold">${this.getAyIsim(a)}</span>`;
                    h += `<span class="font-bold text-lg ${bak < 0 ? 'text-red-700' : 'text-indigo-700'}">${bak.toLocaleString('tr-TR')} ₺</span></div>`;
                    h += '<div class="flex gap-4 text-sm">';
                    h += `<span class="text-green-700">Gelir: ${g.toLocaleString('tr-TR')} ₺</span>`;
                    h += `<span class="text-red-700">Gider: ${topGid.toLocaleString('tr-TR')} ₺</span>`;
                    h += `<span class="text-gray-600">(${gid.length} ödeme)</span></div></div>`;
                });
                h += '</div></div>';
                return h;
            },
            
            render() {
                const stats = this.getStats();
                const fil = this.getFiltreli();
                const gec = this.getAylikGec();
                const yillikGec = this.getYillikGec();
                let h = '';
                
                h += '<div class="bg-white rounded-2xl shadow-lg p-6 mb-6">';
                h += '<div class="flex items-center justify-between"><div>';
                h += '<h1 class="text-3xl font-bold text-gray-800 mb-2"><i data-lucide="dollar-sign"></i> Ödeme Takip</h1>';
                h += `<p class="text-gray-600">${this.currentUser ? this.currentUser.email : ''}</p></div>`;
                h += '<div class="flex gap-2">';
                h += '<button onclick="app.logout()" class="p-3 bg-red-100 text-red-600 rounded-lg hover:bg-red-200" title="Çıkış Yap"><i data-lucide="log-out" style="width:20px"></i></button>';
                h += '</div></div></div>';
                
                h += '<div class="bg-white rounded-2xl shadow-lg p-4 mb-6 hidden md:block"><div class="flex gap-2 flex-wrap">';
                const sekButtons = [
                    ['odemeler', 'calendar', 'Ödemeler'],
                    ['bakiye', 'wallet', 'Bakiye'],
                    ['kategoriler', 'tag', 'Kategoriler'],
                    ['gecmis', 'filter', 'Geçmiş']
                ];
                sekButtons.forEach(([s, icon, label]) => {
                    h += `<button onclick="app.setSekme('${s}')" class="px-6 py-3 rounded-lg font-medium flex items-center gap-2 ${this.sekme === s ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}"><i data-lucide="${icon}" style="width:20px"></i> ${label}</button>`;
                });
                h += '</div></div>';
                
                if (this.sekme === 'bakiye') h += this.renderBakiye();
                if (this.sekme === 'kategoriler') h += this.renderKategoriler();
                
                if (this.sekme === 'odemeler') {
                    h += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">';
                    h += `<div class="bg-white rounded-xl shadow p-4"><p class="text-sm text-gray-600">Bu Ay</p><p class="text-2xl font-bold text-indigo-600">${stats.buAyAdet}</p></div>`;
                    h += `<div class="bg-white rounded-xl shadow p-4"><p class="text-sm text-gray-600">Bu Ay Tutar</p><p class="text-2xl font-bold text-green-600">${stats.buAyToplam.toLocaleString('tr-TR')} ₺</p></div>`;
                    h += `<div class="bg-white rounded-xl shadow p-4"><p class="text-sm text-gray-600">Toplam Bekleyen</p><p class="text-2xl font-bold text-orange-600">${stats.toplamBekleyen.toLocaleString('tr-TR')} ₺</p></div>`;
                    h += `<div class="bg-white rounded-xl shadow p-4 border-2 border-purple-200"><p class="text-sm text-gray-600"><i data-lucide="refresh-cw" style="width:14px"></i> Tekrarlı</p><p class="text-2xl font-bold text-purple-600">${stats.tekrarliAdet} adet</p><p class="text-sm text-purple-600">${stats.tekrarliToplam.toLocaleString('tr-TR')} ₺/ay</p></div>`;
                    h += '</div>';
                    
                    h += '<div class="bg-white rounded-2xl shadow-lg p-6 mb-6">';
                    h += '<div class="flex items-center justify-between mb-4">';
                    h += '<h2 class="text-xl font-bold text-gray-800">Yeni Ödeme Ekle</h2>';
                    h += '<button onclick="app.openYeniOdemeModal()" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg flex items-center gap-2 hover:bg-indigo-700 transition">';
                    h += '<i data-lucide="plus-circle" style="width:20px"></i> Ödeme Ekle</button></div>';
                    h += '<p class="text-sm text-gray-600">Yeni bir ödeme eklemek için yukarıdaki butona tıklayın</p>';
                    h += '</div>';
                    
                    h += '<div class="bg-white rounded-2xl shadow-lg p-4 mb-6">';
                    h += '<div class="mb-4"><input type="text" id="aramaInput" placeholder="Ara..." value="' + this.arama + '" class="w-full border-2 rounded-lg px-4 py-2"></div>';
                    h += '<div class="flex gap-2 flex-wrap mb-3"><span class="text-sm font-semibold py-2">Durum:</span>';
                    const filButtons = [
                        ['hepsi', this.odemeler.length],
                        ['bekleyen', this.odemeler.filter(o => !o.tamamlandi).length],
                        ['buay', this.getBuAyOdemeler().length],
                        ['tekrarli', this.odemeler.filter(o => o.tekrarlar && !o.tamamlandi).length],
                        ['tamamlanan', this.odemeler.filter(o => o.tamamlandi).length]
                    ];
                    const filColors = { hepsi: 'indigo', bekleyen: 'orange', buay: 'blue', tekrarli: 'purple', tamamlanan: 'green' };
                    filButtons.forEach(([f, count]) => {
                        const icon = f === 'buay' ? 'calendar-check' : f === 'tekrarli' ? 'refresh-cw' : '';
                        h += `<button onclick="app.setFiltre('${f}')" class="px-4 py-2 rounded-lg text-sm ${this.filtre === f ? `bg-${filColors[f]}-600 text-white` : 'bg-gray-100 text-gray-700'}">`;
                        if (icon) h += `<i data-lucide="${icon}" style="width:16px"></i> `;
                        h += `${f.charAt(0).toUpperCase() + f.slice(1)} (${count})</button>`;
                    });
                    h += '</div><div class="flex gap-2 flex-wrap"><span class="text-sm font-semibold py-2">Kategori:</span>';
                    h += `<button onclick="app.setKatFiltre('hepsi')" class="px-3 py-1 rounded-lg text-sm ${this.katFiltre === 'hepsi' ? 'bg-indigo-600 text-white' : 'bg-gray-100'}">Tümü</button>`;
                    KATS.forEach(k => {
                        h += `<button onclick="app.setKatFiltre('${k.id}')" class="px-3 py-1 rounded-lg text-sm flex items-center gap-1 ${this.katFiltre === k.id ? k.renk + ' text-white' : 'bg-gray-100'}">`;
                        h += `<i data-lucide="${k.icon}" style="width:14px"></i> ${k.isim}</button>`;
                    });
                    h += '</div></div>';
                    
                    if (this.secili.size > 0) {
                        h += '<div class="bg-indigo-50 border-2 border-indigo-300 rounded-xl p-4 mb-6">';
                        h += `<div class="flex items-center justify-between flex-wrap gap-3"><span class="font-semibold">${this.secili.size} seçildi</span><div class="flex gap-2">`;
                        h += '<button onclick="app.topluTamamla()" class="px-4 py-2 bg-green-600 text-white rounded-lg flex items-center gap-2"><i data-lucide="check-circle" style="width:18px"></i> Toplu Tamamla</button>';
                        h += '<button onclick="app.topluSil()" class="px-4 py-2 bg-red-600 text-white rounded-lg flex items-center gap-2"><i data-lucide="trash-2" style="width:18px"></i> Toplu Sil</button>';
                        h += '<button onclick="app.secili.clear(); app.render(); lucide.createIcons();" class="px-4 py-2 bg-gray-600 text-white rounded-lg">İptal</button>';
                        h += '</div></div></div>';
                    }
                    
                    if (fil.length === 0) {
                        h += '<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500"><i data-lucide="alert-circle" style="width:48px" class="mx-auto mb-4"></i><p class="text-lg">Ödeme bulunamadı</p></div>';
                    } else {
                        h += `<button onclick="app.tumunuSec()" class="w-full md:w-auto px-4 py-2 bg-gray-200 rounded-lg mb-4">${this.secili.size ? 'Seçimi Kaldır' : 'Tümünü Seç'}</button>`;
                        h += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                        fil.forEach(o => {
                            const d = this.durum(o.vadeTarihi, o.tamamlandi);
                            const dText = this.durumText(o.vadeTarihi, o.tamamlandi);
                            const k = KATS.find(x => x.id === o.kategori);
                            const sec = this.secili.has(o.id);
                            h += `<div class="grid-card ${this.durumRenk(d)} border-2 rounded-xl p-4 shadow ${o.tekrarlar && !o.tamamlandi ? 'ring-2 ring-purple-300' : ''} ${sec ? 'ring-4 ring-indigo-400' : ''}">`;
                            h += '<div class="flex items-start gap-2 mb-3">';
                            h += `<input type="checkbox" ${sec ? 'checked' : ''} onchange="app.toggleSecim('${o.id}')" class="mt-1 w-5 h-5 cursor-pointer flex-shrink-0">`;
                            h += '<div class="flex-1 min-w-0">';
                            h += `<h3 class="text-base font-semibold mb-1 ${o.tamamlandi ? 'line-through text-gray-500' : 'text-gray-800'}">${o.aciklama}</h3>`;
                            h += '<div class="flex flex-wrap gap-1 mb-2">';
                            if (k) h += `<span class="text-xs ${k.renk} text-white px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="${k.icon}" style="width:10px"></i> ${k.isim}</span>`;
                            if (o.tekrarlar && !o.tamamlandi) h += '<span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="refresh-cw" style="width:10px"></i> Tekrarlı</span>';
                            h += '</div>';
                            h += `<p class="text-2xl font-bold text-indigo-600 mb-2">${o.tutar.toLocaleString('tr-TR')} ₺</p>`;
                            h += '<div class="text-sm text-gray-600 space-y-1">';
                            h += `<p><i data-lucide="calendar" style="width:12px" class="inline"></i> ${new Date(o.vadeTarihi).toLocaleDateString('tr-TR')}</p>`;
                            h += `<p class="font-medium ${d === 'gecmis' ? 'text-red-600' : d === 'acil' ? 'text-orange-600' : ''}">${dText}</p>`;
                            h += '</div></div></div>';
                            h += '<div class="flex flex-col gap-2 mt-3">';
                            h += `<button onclick="app.openEditModal('${o.id}')" class="w-full p-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 transition flex items-center justify-center gap-2"><i data-lucide="edit" style="width:16px"></i> Düzenle</button>`;
                            if (o.tekrarlar && !o.tamamlandi) h += `<button onclick="app.tekrarDurdur('${o.id}')" class="w-full p-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium hover:bg-purple-200 transition flex items-center justify-center gap-2"><i data-lucide="x-circle" style="width:16px"></i> Tekrarı Durdur</button>`;
                            h += `<button onclick="app.odemeTamamla('${o.id}')" class="w-full p-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 ${o.tamamlandi ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-gray-200 hover:bg-gray-300'}"><i data-lucide="check-circle" style="width:16px"></i> ${o.tamamlandi ? 'Ödendi' : 'Tamamla'}</button>`;
                            h += `<button onclick="app.odemeSil('${o.id}')" class="w-full p-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition flex items-center justify-center gap-2"><i data-lucide="trash-2" style="width:16px"></i> Sil</button>`;
                            h += '</div></div>';
                        });
                        h += '</div>';
                    }
                }
                
                if (this.sekme === 'gecmis') {
                    h += '<div class="bg-white rounded-2xl shadow-lg p-4 mb-6">';
                    h += '<div class="flex gap-2">';
                    h += `<button onclick="app.setGecmisSekme('aylik')" class="px-6 py-3 rounded-lg font-medium ${this.gecmisSekme === 'aylik' ? 'bg-indigo-600 text-white' : 'bg-gray-100'}">Aylık Geçmiş</button>`;
                    h += `<button onclick="app.setGecmisSekme('yillik')" class="px-6 py-3 rounded-lg font-medium ${this.gecmisSekme === 'yillik' ? 'bg-indigo-600 text-white' : 'bg-gray-100'}">Yıllık Geçmiş</button>`;
                    h += '</div></div>';
                    
                    if (this.gecmisSekme === 'aylik') {
                        h += '<div class="space-y-4">';
                        if (gec.length === 0) {
                            h += '<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500"><i data-lucide="alert-circle" style="width:48px" class="mx-auto mb-4"></i><p class="text-lg">Tamamlanmış ödeme yok</p></div>';
                        } else {
                            gec.forEach(ay => {
                                h += '<div class="bg-white rounded-2xl shadow-lg p-6">';
                                h += `<div class="flex items-center justify-between mb-4 pb-4 border-b-2"><h2 class="text-2xl font-bold"><i data-lucide="calendar"></i> ${ay.ay}</h2>`;
                                h += `<div class="text-right"><p class="text-sm text-gray-600">${ay.adet} Ödeme</p><p class="text-2xl font-bold text-indigo-600">${ay.toplam.toLocaleString('tr-TR')} ₺</p></div></div>`;
                                h += '<div class="space-y-2">';
                                ay.odemeler.forEach(o => {
                                    const k = KATS.find(x => x.id === o.kategori);
                                    h += '<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">';
                                    h += `<div><div class="flex items-center gap-2"><p class="font-medium">${o.aciklama}</p>`;
                                    if (k) h += `<span class="text-xs ${k.renk} text-white px-2 py-1 rounded-full">${k.isim}</span>`;
                                    if (o.tekrarlar) h += '<i data-lucide="refresh-cw" style="width:14px" class="text-purple-600"></i>';
                                    h += `</div><p class="text-sm text-gray-600">Ödeme: ${o.odemeTarihi ? new Date(o.odemeTarihi).toLocaleDateString('tr-TR') : 'Bilinmiyor'}</p></div>`;
                                    h += `<span class="font-bold text-lg">${o.tutar.toLocaleString('tr-TR')} ₺</span></div>`;
                                });
                                h += '</div></div>';
                            });
                        }
                        h += '</div>';
                    } else {
                        h += '<div class="space-y-4">';
                        if (yillikGec.length === 0) {
                            h += '<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500"><i data-lucide="alert-circle" style="width:48px" class="mx-auto mb-4"></i><p class="text-lg">Yıllık veri yok</p></div>';
                        } else {
                            yillikGec.forEach(yilData => {
                                h += '<div class="bg-white rounded-2xl shadow-lg p-6">';
                                h += `<div class="flex items-center justify-between mb-4 pb-4 border-b-2">`;
                                h += `<h2 class="text-2xl font-bold"><i data-lucide="calendar"></i> ${yilData.yil}</h2>`;
                                h += '<div class="grid grid-cols-3 gap-4 text-right">';
                                h += `<div><p class="text-xs text-green-700">Toplam Gelir</p><p class="text-lg font-bold text-green-700">${yilData.toplamGelir.toLocaleString('tr-TR')} ₺</p></div>`;
                                h += `<div><p class="text-xs text-red-700">Toplam Gider</p><p class="text-lg font-bold text-red-700">${yilData.toplamGider.toLocaleString('tr-TR')} ₺</p></div>`;
                                h += `<div><p class="text-xs ${yilData.toplamBakiye < 0 ? 'text-red-700' : 'text-indigo-700'}">Yıl Bakiye</p><p class="text-lg font-bold ${yilData.toplamBakiye < 0 ? 'text-red-700' : 'text-indigo-700'}">${yilData.toplamBakiye.toLocaleString('tr-TR')} ₺</p></div>`;
                                h += '</div></div>';
                                h += '<div class="space-y-2">';
                                yilData.aylarArr.forEach(ay => {
                                    h += `<div class="p-4 rounded-xl border-2 ${ay.bakiye < 0 ? 'bg-red-50 border-red-300' : 'bg-gray-50 border-gray-200'}">`;
                                    h += `<div class="flex items-center justify-between mb-2">`;
                                    h += `<span class="font-bold">${ay.ay}</span>`;
                                    h += `<span class="font-bold text-lg ${ay.bakiye < 0 ? 'text-red-700' : 'text-indigo-700'}">${ay.bakiye.toLocaleString('tr-TR')} ₺</span>`;
                                    h += '</div><div class="flex gap-4 text-sm">';
                                    h += `<span class="text-green-700">Gelir: ${ay.gelir.toLocaleString('tr-TR')} ₺</span>`;
                                    h += `<span class="text-red-700">Gider: ${ay.gider.toLocaleString('tr-TR')} ₺</span>`;
                                    h += `<span class="text-gray-600">(${ay.adet} ödeme)</span></div></div>`;
                                });
                                h += '</div></div>';
                            });
                        }
                        h += '</div>';
                    }
                }
                
                document.getElementById('app').innerHTML = h;
                
                const editKatSel = document.getElementById('editKategori');
                if (editKatSel) {
                    editKatSel.innerHTML = '';
                    KATS.forEach(k => {
                        const opt = document.createElement('option');
                        opt.value = k.id;
                        opt.textContent = k.isim;
                        editKatSel.appendChild(opt);
                    });
                }
                
                const modalKatSel = document.getElementById('modalKategori');
                if (modalKatSel) {
                    modalKatSel.innerHTML = '';
                    KATS.forEach(k => {
                        const opt = document.createElement('option');
                        opt.value = k.id;
                        opt.textContent = k.isim;
                        modalKatSel.appendChild(opt);
                    });
                }
                
                if (this.sekme === 'odemeler') {
                    const aramaInput = document.getElementById('aramaInput');
                    if (aramaInput) aramaInput.addEventListener('input', (e) => this.setArama(e.target.value));
                }
                
                lucide.createIcons();
            }
        };
        
        lucide.createIcons();
    </script>
</body>
</html>